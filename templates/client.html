<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalNetMessage - Client</title>
    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="/static/style.css?v=2.1">
    <link rel="stylesheet" href="/static/modern-overrides.css?v=2.1">
    <link rel="stylesheet" href="/static/client-modern.css?v=2.1">
    <link rel="stylesheet" href="/static/themes.css?v=1.0">
    <link rel="stylesheet" href="/static/theme-selector.css?v=1.0">
    <link rel="stylesheet" href="/static/encryption-ui.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container client-view">
        <!-- Header -->
        <header class="header client-header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-wrapper">
                        <svg width="40" height="40" viewBox="0 0 40 40" fill="none" class="logo-svg">
                            <circle cx="20" cy="20" r="18" stroke="url(#gradient)" stroke-width="2.5"/>
                            <circle cx="20" cy="20" r="8" fill="url(#gradient)"/>
                            <circle cx="20" cy="20" r="3" fill="white" opacity="0.9"/>
                            <defs>
                                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#667eea"/>
                                    <stop offset="100%" style="stop-color:#764ba2"/>
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                    <div class="logo-text">
                        <h1>LocalNetMessage</h1>
                        <span class="client-badge">Client</span>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="theme-selector-wrapper">
                        <button class="theme-selector-btn" id="theme-menu-btn" onclick="toggleThemeMenu()" aria-label="S√©lectionner un th√®me" title="Th√®mes">
                            üé®
                        </button>
                        <div class="theme-menu" id="theme-menu" style="display: none;">
                            <div class="theme-option" onclick="setTheme('violet')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)" title="Violet"></div>
                            <div class="theme-option" onclick="setTheme('rose')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%)" title="Rose"></div>
                            <div class="theme-option" onclick="setTheme('cyan')" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)" title="Cyan"></div>
                            <div class="theme-option" onclick="setTheme('green')" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)" title="Vert"></div>
                            <div class="theme-option" onclick="setTheme('orange')" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%)" title="Orange"></div>
                            <div class="theme-option" onclick="setTheme('turquoise')" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%)" title="Turquoise"></div>
                            <div class="theme-option" onclick="setTheme('peach')" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)" title="P√™che"></div>
                            <div class="theme-option" onclick="setTheme('indigo')" style="background: linear-gradient(135deg, #667eea 0%, #5568d3 100%)" title="Indigo"></div>
                            <div class="theme-option" onclick="setTheme('coral')" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)" title="Corail"></div>
                        </div>
                    </div>
                    <div class="connection-status-wrapper" id="connection-status">
                        <div class="status-indicator">
                            <span class="status-pulse disconnected"></span>
                            <span class="status-dot disconnected"></span>
                        </div>
                        <span class="status-text">D√©connect√©</span>
                    </div>
                    <button class="theme-toggle-btn" id="theme-toggle" onclick="toggleTheme()" aria-label="Changer le th√®me">
                        <span class="icon-sun">‚òÄÔ∏è</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Connection Panel -->
        <div class="connection-panel modern-panel" id="connection-panel">
            <div class="connection-background">
                <div class="gradient-orb orb-1"></div>
                <div class="gradient-orb orb-2"></div>
                <div class="gradient-orb orb-3"></div>
            </div>
            
            <div class="connection-card glass-card">
                <div class="connection-header">
                    <div class="connection-icon-wrapper">
                        <svg width="80" height="80" viewBox="0 0 80 80" fill="none" class="connection-icon">
                            <circle cx="40" cy="40" r="35" stroke="url(#gradient3)" stroke-width="3" opacity="0.3"/>
                            <circle cx="40" cy="40" r="28" stroke="url(#gradient3)" stroke-width="3"/>
                            <path d="M40 25v30M25 40h30" stroke="url(#gradient3)" stroke-width="3.5" stroke-linecap="round"/>
                            <circle cx="40" cy="40" r="5" fill="url(#gradient3)"/>
                            <defs>
                                <linearGradient id="gradient3" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#667eea"/>
                                    <stop offset="100%" style="stop-color:#764ba2"/>
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                    <h2 class="connection-title">Connexion au serveur</h2>
                    <p class="connection-subtitle">Entrez vos informations pour d√©marrer la conversation</p>
                </div>
                
                <div class="connection-form">
                    <div class="form-group modern-form-group">
                        <label for="username" class="form-label">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="currentColor">
                                <path d="M9 9a4 4 0 100-8 4 4 0 000 8zm0 2c-4 0-8 2-8 4v1h16v-1c0-2-4-4-8-4z"/>
                            </svg>
                            Nom d'utilisateur
                        </label>
                        <input 
                            type="text" 
                            id="username" 
                            placeholder="Votre nom" 
                            class="input-field modern-input"
                            required
                            autocomplete="off"
                        >
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group modern-form-group">
                            <label for="server-ip" class="form-label">
                                <svg width="18" height="18" viewBox="0 0 18 18" fill="currentColor">
                                    <path d="M2 4h14v2H2V4zm0 4h14v2H2V8zm0 4h14v2H2v-2z"/>
                                    <circle cx="4" cy="5" r="0.5" fill="white"/>
                                    <circle cx="4" cy="9" r="0.5" fill="white"/>
                                    <circle cx="4" cy="13" r="0.5" fill="white"/>
                                </svg>
                                Adresse IP
                            </label>
                            <input 
                                type="text" 
                                id="server-ip" 
                                placeholder="127.0.0.1" 
                                value="127.0.0.1"
                                class="input-field modern-input"
                            >
                        </div>
                        
                        <div class="form-group modern-form-group">
                            <label for="server-port" class="form-label">
                                <svg width="18" height="18" viewBox="0 0 18 18" fill="currentColor">
                                    <path d="M9 2L3 5v6c0 3.5 2.5 6.5 6 7.3 3.5-.8 6-3.8 6-7.3V5l-6-3zm0 2.2l4 2V11c0 2.5-1.7 4.7-4 5.3-2.3-.6-4-2.8-4-5.3V6.2l4-2z"/>
                                </svg>
                                Port
                            </label>
                            <input 
                                type="number" 
                                id="server-port" 
                                placeholder="12345" 
                                value="12345"
                                class="input-field modern-input"
                            >
                        </div>
                    </div>

                    <button class="btn-connect modern-connect-btn" onclick="connectToServer()">
                        <span class="btn-content">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm-1 11.5l-3-3 1.5-1.5 1.5 1.5 3.5-3.5 1.5 1.5-5 5z"/>
                            </svg>
                            Se connecter
                        </span>
                        <div class="btn-shimmer"></div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-container modern-chat-container client-chat" id="chat-container" style="display: none;">
            <div class="chat-header modern-chat-header">
                <div class="chat-header-info">
                    <div class="server-avatar">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M4 6h16v2H4V6zm0 5h16v2H4v-2zm0 5h16v2H4v-2z"/>
                            <circle cx="6" cy="7" r="0.8" fill="white"/>
                            <circle cx="6" cy="12" r="0.8" fill="white"/>
                            <circle cx="6" cy="17" r="0.8" fill="white"/>
                        </svg>
                    </div>
                    <div class="server-details">
                        <h2>Serveur</h2>
                        <span class="server-address" id="server-address-display"></span>
                    </div>
                </div>
                <div class="chat-actions">
                    <input type="file" id="file-input" style="display:none" />
                    <button class="btn-icon modern-btn-icon" onclick="document.getElementById('file-input').click()" title="Envoyer un fichier">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14.59 2.59a2 2 0 012.82 0l4 4a2 2 0 010 2.82l-9.17 9.17a4 4 0 01-5.66-5.66L14 7.41a1 1 0 111.41 1.41l-6.59 6.59a2 2 0 102.83 2.83L21.17 7 17 2.83 14.59 5.24 13.17 3.83l1.42-1.24z"/>
                        </svg>
                    </button>
                    <button class="btn-icon modern-btn-icon" onclick="clearMessages()" title="Effacer les messages">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/>
                        </svg>
                    </button>
                    <button class="btn-icon modern-btn-icon btn-disconnect" onclick="disconnectFromServer()" title="Se d√©connecter">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 11-2 0V4H5v12h10v-2a1 1 0 112 0v3a1 1 0 01-1 1H4a1 1 0 01-1-1V3z"/>
                            <path d="M11 10a1 1 0 011-1h4.586l-1.293-1.293a1 1 0 011.414-1.414l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L16.586 11H12a1 1 0 01-1-1z"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="messages-container modern-messages" id="messages">
                <div class="welcome-message modern-welcome">
                    <div class="welcome-icon-wrapper">
                        <div class="welcome-icon">üéâ</div>
                    </div>
                    <h3>Connect√© avec succ√®s!</h3>
                    <p>Vous pouvez maintenant √©changer des messages avec le serveur.</p>
                </div>
            </div>

            <div class="input-container modern-input-container">
                <div class="format-toolbar modern-toolbar">
                    <div class="toolbar-group">
                        <button class="btn-format modern-btn-format" onclick="formatText('bold')" title="Gras (Ctrl+B)">
                            <strong>B</strong>
                        </button>
                        <button class="btn-format modern-btn-format" onclick="formatText('italic')" title="Italique (Ctrl+I)">
                            <em>I</em>
                        </button>
                        <button class="btn-format modern-btn-format emoji-btn" onclick="toggleEmojiPicker()" title="Emojis">
                            üòä
                        </button>
                    </div>
                    <div class="emoji-picker modern-emoji-picker" id="emoji-picker" style="display: none;">
                        <div class="emoji-grid">
                            <button onclick="insertEmoji('üòä')">üòä</button>
                            <button onclick="insertEmoji('üòÇ')">üòÇ</button>
                            <button onclick="insertEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                            <button onclick="insertEmoji('üëç')">üëç</button>
                            <button onclick="insertEmoji('üéâ')">üéâ</button>
                            <button onclick="insertEmoji('üî•')">üî•</button>
                            <button onclick="insertEmoji('‚ú®')">‚ú®</button>
                            <button onclick="insertEmoji('üíØ')">üíØ</button>
                            <button onclick="insertEmoji('üöÄ')">üöÄ</button>
                            <button onclick="insertEmoji('‚≠ê')">‚≠ê</button>
                            <button onclick="insertEmoji('üí™')">üí™</button>
                            <button onclick="insertEmoji('üôè')">üôè</button>
                            <button onclick="insertEmoji('üòé')">üòé</button>
                            <button onclick="insertEmoji('ü§î')">ü§î</button>
                            <button onclick="insertEmoji('üëè')">üëè</button>
                            <button onclick="insertEmoji('üéØ')">üéØ</button>
                        </div>
                    </div>
                </div>
                <div class="input-wrapper modern-input-wrapper">
                    <textarea 
                        id="message-input" 
                        placeholder="Tapez votre message..."
                        rows="1"
                        maxlength="5000"
                        class="message-textarea"
                    ></textarea>
                    <button class="btn-send modern-btn-send" id="send-btn" onclick="sendMessage()">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
                <div class="input-hint modern-hint">
                    <kbd>Shift</kbd> + <kbd>Enter</kbd> nouvelle ligne ‚Ä¢ <kbd>Enter</kbd> envoyer
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        let socket = io('http://localhost:5001');  // Connexion Socket.IO d√®s le chargement
        let isConnected = false;
        const messageInput = document.getElementById('message-input');
        const messagesContainer = document.getElementById('messages');

        // Connexion au serveur
        function connectToServer() {
            const username = document.getElementById('username').value.trim();
            const serverIp = document.getElementById('server-ip').value.trim();
            const serverPort = document.getElementById('server-port').value.trim();

            if (!username) {
                alert('Veuillez entrer un nom d\'utilisateur.');
                return;
            }

            if (!serverIp || !serverPort) {
                alert('Veuillez entrer une adresse IP et un port valides.');
                return;
            }

            // D√©clencher la connexion TCP via Socket.IO
            socket.emit('connect_to_server', {
                username: username,
                server_ip: serverIp,
                server_port: serverPort
            });
        }

        // √âv√©nements Socket.IO (initialis√©s d√®s le chargement)
        socket.on('connect', () => {
            console.log('Socket.IO connect√© au serveur Flask client_web.py');
        });

        socket.on('connected', (data) => {
            isConnected = true;
            document.getElementById('connection-panel').style.display = 'none';
            document.getElementById('chat-container').style.display = 'flex';
            document.getElementById('server-address-display').textContent = `${data.server_ip}:${data.server_port}`;
            updateConnectionStatus(true);
            addSystemMessage('Connect√© au serveur');
        });

        socket.on('connection_error', (data) => {
            alert(data.message);
            isConnected = false;
            updateConnectionStatus(false);
        });

        socket.on('disconnected', (data) => {
            isConnected = false;
            updateConnectionStatus(false);
            addSystemMessage(data.reason || 'D√©connect√© du serveur');
        });

        socket.on('error', (data) => {
            addSystemMessage('Erreur: ' + data.message);
        });

        socket.on('message_received', (data) => {
            const senderName = data.server_username || 'Serveur';
            
            // D√©chiffrer le message si c'est un message chiffr√©
            let messageContent = data.message;
            if (encryption && data.message.startsWith('[ENCRYPTED]')) {
                try {
                    messageContent = encryption.decrypt(data.message);
                } catch (e) {
                    console.warn('Impossible de d√©chiffrer le message:', e);
                    messageContent = '[Message chiffr√© - cl√© introuvable]';
                }
            }
            
            addMessage(senderName, messageContent, 'received');
        });

        socket.on('message_sent', (data) => {
            // D√©chiffrer le message si c'est un message chiffr√© (pour l'affichage)
            let messageContent = data.message;
            if (encryption && data.message.startsWith('[ENCRYPTED]')) {
                try {
                    messageContent = encryption.decrypt(data.message);
                } catch (e) {
                    console.warn('Message chiffr√© non d√©chiffrable');
                    messageContent = '[Message chiffr√© - affichage original]';
                }
            }
            
            addMessage('Vous', messageContent, 'sent', data.message_id);
        });
        
        socket.on('file_received', (data) => {
            const senderName = data.server_username || 'Serveur';
            addFileMessage(senderName, data.filename, data.url, 'received');
        });
        
        socket.on('file_sent', (data) => {
            const url = `/files/client/sent/${data.filename}`;
            addFileMessage('Vous', data.filename, url, 'sent');
        });
        
        socket.on('message_read', (data) => {
            updateReadStatus(data.message_id, 'read');
        });

        // D√©connexion du serveur
        function disconnectFromServer() {
            if (socket) {
                socket.emit('disconnect_from_server');
                socket.disconnect();
                socket = null;
            }
            isConnected = false;
            document.getElementById('connection-panel').style.display = 'flex';
            document.getElementById('chat-container').style.display = 'none';
            updateConnectionStatus(false);
            messagesContainer.innerHTML = `
                <div class="welcome-message modern-welcome">
                    <div class="welcome-icon-wrapper">
                        <div class="welcome-icon">üéâ</div>
                    </div>
                    <h3>Connect√© avec succ√®s!</h3>
                    <p>Vous pouvez maintenant √©changer des messages avec le serveur.</p>
                </div>
            `;
        }

        // Mise √† jour du statut de connexion
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            const statusDot = statusElement.querySelector('.status-dot');
            const statusPulse = statusElement.querySelector('.status-pulse');
            const statusText = statusElement.querySelector('.status-text');

            if (connected) {
                statusDot.classList.remove('disconnected');
                statusDot.classList.add('connected');
                if (statusPulse) {
                    statusPulse.classList.remove('disconnected');
                    statusPulse.classList.add('connected');
                }
                statusText.textContent = 'Connect√©';
            } else {
                statusDot.classList.remove('connected');
                statusDot.classList.add('disconnected');
                if (statusPulse) {
                    statusPulse.classList.remove('connected');
                    statusPulse.classList.add('disconnected');
                }
                statusText.textContent = 'D√©connect√©';
            }
        }

        // Envoyer un message
        function sendMessage() {
            const message = messageInput.value.trim();
            
            // Validation du message
            if (!message) {
                showValidationError('Le message ne peut pas √™tre vide.');
                return;
            }
            
            if (message.length > 5000) {
                showValidationError('Le message ne peut pas d√©passer 5000 caract√®res.');
                return;
            }
            
            if (!socket || !isConnected) {
                showValidationError('Vous n\'√™tes pas connect√© au serveur.');
                return;
            }
            
            // Chiffrer le message si le chiffrement est activ√©
            let messageToSend = message;
            if (encryption && encryption.isEnabled()) {
                messageToSend = encryption.encrypt(message);
            }
            
            socket.emit('send_message', {
                message: messageToSend
            });
            messageInput.value = '';
            updateCharCount();
            autoResize();
        }

        // Ajouter un message
        function addMessage(sender, message, type, messageId = null) {
            const welcomeMsg = messagesContainer.querySelector('.welcome-message, .modern-welcome');
            if (welcomeMsg) welcomeMsg.remove();

            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});

            const messageElement = document.createElement('div');
            messageElement.className = `message modern-message ${type}`;
            if (messageId) {
                messageElement.dataset.messageId = messageId;
            }
            
            // G√©n√©rer une couleur d'avatar bas√©e sur le nom
            const avatarColor = getAvatarColor(sender);
            const avatarInitial = sender.charAt(0).toUpperCase();
            
            // Statut de lecture pour les messages envoy√©s
            const readStatus = type === 'sent' ? '<span class="read-status modern-read-status" data-status="sent">‚úì</span>' : '';
            
            messageElement.innerHTML = `
                <div class="message-avatar modern-avatar" style="background: ${avatarColor};">
                    ${avatarInitial}
                </div>
                <div class="message-bubble modern-bubble ${type}">
                    <div class="message-header modern-msg-header">
                        <span class="message-sender modern-sender">${sender}</span>
                        <span class="message-time modern-time">${timeString}</span>
                    </div>
                    <div class="message-text modern-msg-text">${formatMessage(escapeHtml(message))}</div>
                    ${readStatus}
                </div>
            `;
            messageElement.classList.add('message-enter');
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Animation d'entr√©e
            setTimeout(() => messageElement.classList.add('message-visible'), 10);
            
            // Notification sonore pour les messages re√ßus
            if (type === 'received') {
                playNotificationSound();
            }
            
            return messageElement;
        }

        // Ajouter un message fichier (avec lien)
        function addFileMessage(sender, filename, url, type) {
            const welcomeMsg = messagesContainer.querySelector('.welcome-message, .modern-welcome');
            if (welcomeMsg) welcomeMsg.remove();

            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});

            const messageElement = document.createElement('div');
            messageElement.className = `message modern-message ${type}`;
            const avatarColor = getAvatarColor(sender);
            const avatarInitial = sender.charAt(0).toUpperCase();
            messageElement.innerHTML = `
                <div class="message-avatar modern-avatar" style="background: ${avatarColor};">
                    ${avatarInitial}
                </div>
                <div class="message-bubble modern-bubble ${type}">
                    <div class="message-header modern-msg-header">
                        <span class="message-sender modern-sender">${sender}</span>
                        <span class="message-time modern-time">${timeString}</span>
                    </div>
                    <div class="message-text modern-msg-text">
                        <a href="${url}" target="_blank" download>${filename}</a>
                    </div>
                </div>
            `;
            messageElement.classList.add('message-enter');
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            setTimeout(() => messageElement.classList.add('message-visible'), 10);
        }
        
        // G√©n√©rer une couleur d'avatar unique bas√©e sur le nom
        function getAvatarColor(name) {
            const colors = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
            ];
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash) % colors.length];
        }

        // Ajouter un message syst√®me
        function addSystemMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message system modern-system-msg';
            messageElement.innerHTML = `
                <div class="system-message modern-system">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 0a8 8 0 100 16A8 8 0 008 0zm1 12H7V7h2v5zm0-6H7V4h2v2z"/>
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            messageElement.classList.add('message-enter');
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            setTimeout(() => messageElement.classList.add('message-visible'), 10);
        }

        // Effacer les messages
        function clearMessages() {
            messagesContainer.innerHTML = `
                <div class="welcome-message modern-welcome">
                    <div class="welcome-icon-wrapper">
                        <div class="welcome-icon">üí¨</div>
                    </div>
                    <h3>Messages effac√©s</h3>
                    <p>La conversation continue...</p>
                </div>
            `;
        }

        // Auto-resize textarea
        function autoResize() {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
        }

        messageInput.addEventListener('input', autoResize);

        // Gestion des touches
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Formater le message (gras, italique, emojis)
        function formatMessage(text) {
            // Gras: **texte** -> <strong>texte</strong>
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // Italique: *texte* -> <em>texte</em>
            text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
            
            // Saut de ligne
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }
        
        // Formater le texte (gras, italique)
        function formatText(format) {
            const textarea = messageInput;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            if (!selectedText) {
                alert('Veuillez s√©lectionner du texte √† formater.');
                return;
            }
            
            let formattedText = '';
            if (format === 'bold') {
                formattedText = `**${selectedText}**`;
            } else if (format === 'italic') {
                formattedText = `*${selectedText}*`;
            }
            
            textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + formattedText.length, start + formattedText.length);
            updateCharCount();
        }
        
        // Toggle emoji picker
        function toggleEmojiPicker() {
            const picker = document.getElementById('emoji-picker');
            picker.style.display = picker.style.display === 'none' ? 'grid' : 'none';
        }
        
        // Ins√©rer un emoji
        function insertEmoji(emoji) {
            const textarea = messageInput;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            
            textarea.value = textarea.value.substring(0, start) + emoji + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + emoji.length, start + emoji.length);
            
            toggleEmojiPicker();
            updateCharCount();
        }
        
        // Mettre √† jour le compteur de caract√®res
        function updateCharCount() {
            // Fonction d√©sactiv√©e - compteur retir√© de l'interface
        }
        
        // Afficher une erreur de validation
        function showValidationError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'validation-error';
            errorDiv.textContent = message;
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;
            
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => errorDiv.remove(), 300);
            }, 3000);
        }
        
        // Jouer un son de notification
        function playNotificationSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }
        
        // Mettre √† jour le statut de lecture
        function updateReadStatus(messageId, status) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                const readStatusElement = messageElement.querySelector('.read-status');
                if (readStatusElement) {
                    readStatusElement.dataset.status = status;
                    if (status === 'read') {
                        readStatusElement.innerHTML = '‚úì‚úì';
                        readStatusElement.style.color = '#48bb78';
                    }
                }
            }
        }
        
        // Mise √† jour du compteur lors de la saisie
        messageInput.addEventListener('input', () => {
            updateCharCount();
            autoResize();
        });
        
        // Raccourcis clavier pour le formatage
        messageInput.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'b') {
                e.preventDefault();
                formatText('bold');
            } else if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                formatText('italic');
            }
        });
        
        // Fermer le s√©lecteur d'emojis si on clique ailleurs
        // Gestion du th√®me
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark');
            } else {
                document.body.classList.remove('dark');
            }
            updateThemeToggleIcon();
        }
        function updateThemeToggleIcon() {
            const btn = document.getElementById('theme-toggle');
            if (!btn) return;
            const isDark = document.body.classList.contains('dark');
            btn.innerHTML = isDark ? '<span class="icon-moon">üåô</span>' : '<span class="icon-sun">‚òÄÔ∏è</span>';
        }
        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeToggleIcon();
        }
        function initTheme() {
            const saved = localStorage.getItem('theme');
            if (saved) applyTheme(saved);
            else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) applyTheme('dark');
            else applyTheme('light');
        }
        initTheme();

        document.addEventListener('click', (e) => {
            const emojiPicker = document.getElementById('emoji-picker');
            const emojiButton = e.target.closest('.btn-format');
            
            if (emojiPicker && !emojiPicker.contains(e.target) && !emojiButton) {
                emojiPicker.style.display = 'none';
            }
        });

        // Gestion envoi de fichier
        document.getElementById('file-input').addEventListener('change', (e) => {
            console.log('File input changed, socket:', socket, 'connected:', socket ? socket.connected : 'N/A', 'isConnected:', isConnected);
            if (!socket || !socket.connected) {
                showValidationError("Socket.IO non connect√© au serveur Flask.");
                e.target.value = '';
                return;
            }
            if (!isConnected) {
                showValidationError("Vous n'√™tes pas connect√© au serveur TCP.");
                e.target.value = '';
                return;
            }
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) {
                showValidationError('Fichier trop volumineux (max 2 Mo).');
                e.target.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = () => {
                const b64 = (reader.result || '').toString().split(',')[1] || '';
                console.log('Client: envoi fichier', file.name, file.type, file.size);
                console.log('√âmission send_file via socket.io...');
                socket.emit('send_file', {
                    filename: file.name,
                    mimetype: file.type || 'application/octet-stream',
                    data_base64: b64
                });
                console.log('send_file √©mis.');
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        });

        // ========== GESTION DES TH√àMES PERSONNALIS√âS ==========
        
        // Initialiser le th√®me
        function initColorTheme() {
            const savedTheme = localStorage.getItem('colorTheme') || 'violet';
            setTheme(savedTheme);
        }
        
        // D√©finir un th√®me
        function setTheme(themeName) {
            const html = document.documentElement;
            const allThemes = ['violet', 'rose', 'cyan', 'green', 'orange', 'turquoise', 'peach', 'indigo', 'coral'];
            
            // Ajouter transition
            html.classList.add('theme-transitioning');
            
            // Retirer tous les th√®mes
            allThemes.forEach(theme => html.classList.remove(`theme-${theme}`));
            
            // Ajouter le nouveau th√®me
            html.classList.add(`theme-${themeName}`);
            
            // Mettre √† jour le s√©lecteur visuel
            updateThemeSelection(themeName);
            
            // Sauvegarder le choix
            localStorage.setItem('colorTheme', themeName);
            
            // Retirer la transition apr√®s l'animation
            setTimeout(() => html.classList.remove('theme-transitioning'), 300);
        }
        
        // Basculer le menu de s√©lection
        function toggleThemeMenu() {
            const menu = document.getElementById('theme-menu');
            if (menu) {
                menu.style.display = menu.style.display === 'none' ? 'grid' : 'none';
            }
        }
        
        // Fermer le menu quand on clique ailleurs
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('theme-menu');
            const btn = document.getElementById('theme-menu-btn');
            if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.style.display = 'none';
            }
        });
        
        // Mettre √† jour la s√©lection visuelle
        function updateThemeSelection(themeName) {
            const options = document.querySelectorAll('.theme-option');
            options.forEach(opt => opt.classList.remove('active'));
            const activeOption = document.querySelector(`.theme-option[onclick*="'${themeName}'"]`);
            if (activeOption) activeOption.classList.add('active');
        }
        
        // Initialiser au chargement de la page
        window.addEventListener('load', function() {
            initColorTheme();
        });
    </script>
    
    <!-- Scripts de chiffrement -->
    <script src="/static/encryption.js"></script>
    <script src="/static/encryption-ui.js"></script>
</body>
</html>
