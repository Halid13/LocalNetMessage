<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalNetMessage - Client</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container client-view">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <circle cx="16" cy="16" r="14" stroke="url(#gradient)" stroke-width="2"/>
                        <circle cx="16" cy="16" r="6" fill="url(#gradient)"/>
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#667eea"/>
                                <stop offset="100%" style="stop-color:#764ba2"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    <h1>LocalNetMessage</h1>
                </div>
                <div class="connection-status" id="connection-status">
                    <span class="status-dot disconnected"></span>
                    <span>DÃ©connectÃ©</span>
                </div>
            </div>
        </header>

        <!-- Connection Panel -->
        <div class="connection-panel" id="connection-panel">
            <div class="connection-card">
                <div class="connection-icon">
                    <svg width="64" height="64" viewBox="0 0 64 64" fill="none">
                        <circle cx="32" cy="32" r="28" stroke="url(#gradient2)" stroke-width="3"/>
                        <path d="M32 20v24M20 32h24" stroke="url(#gradient2)" stroke-width="3" stroke-linecap="round"/>
                        <defs>
                            <linearGradient id="gradient2" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#667eea"/>
                                <stop offset="100%" style="stop-color:#764ba2"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <h2>Connexion au serveur</h2>
                <p>Entrez votre nom d'utilisateur et l'adresse du serveur</p>
                
                <div class="form-group">
                    <label for="username">Nom d'utilisateur</label>
                    <input 
                        type="text" 
                        id="username" 
                        placeholder="Votre nom" 
                        class="input-field"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label for="server-ip">Adresse IP du serveur</label>
                    <input 
                        type="text" 
                        id="server-ip" 
                        placeholder="127.0.0.1" 
                        value="127.0.0.1"
                        class="input-field"
                    >
                </div>
                
                <div class="form-group">
                    <label for="server-port">Port</label>
                    <input 
                        type="number" 
                        id="server-port" 
                        placeholder="12345" 
                        value="12345"
                        class="input-field"
                    >
                </div>

                <button class="btn-connect" onclick="connectToServer()">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9V7h2v6zm0-8H9V3h2v2z"/>
                    </svg>
                    Se connecter
                </button>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-container client-chat" id="chat-container" style="display: none;">
            <div class="chat-header">
                <div class="server-info-header">
                    <h2>Conversation avec le serveur</h2>
                    <span id="server-address-display"></span>
                </div>
                <div class="chat-actions">
                    <button class="btn-icon" onclick="clearMessages()" title="Effacer les messages">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/>
                        </svg>
                    </button>
                    <button class="btn-icon btn-disconnect" onclick="disconnectFromServer()" title="Se dÃ©connecter">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 11-2 0V4H5v12h10v-2a1 1 0 112 0v3a1 1 0 01-1 1H4a1 1 0 01-1-1V3z"/>
                            <path d="M11 10a1 1 0 011-1h4.586l-1.293-1.293a1 1 0 011.414-1.414l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L16.586 11H12a1 1 0 01-1-1z"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="messages-container" id="messages">
                <div class="welcome-message">
                    <div class="welcome-icon">ğŸ‰</div>
                    <h3>ConnectÃ© avec succÃ¨s!</h3>
                    <p>Vous pouvez maintenant Ã©changer des messages avec le serveur.</p>
                </div>
            </div>

            <div class="input-container">
                <div class="format-toolbar">
                    <button class="btn-format" onclick="formatText('bold')" title="Gras (Ctrl+B)">
                        <strong>B</strong>
                    </button>
                    <button class="btn-format" onclick="formatText('italic')" title="Italique (Ctrl+I)">
                        <em>I</em>
                    </button>
                    <button class="btn-format" onclick="toggleEmojiPicker()" title="Emojis">
                        ğŸ˜Š
                    </button>
                    <div class="emoji-picker" id="emoji-picker" style="display: none;">
                        <button onclick="insertEmoji('ğŸ˜Š')">ğŸ˜Š</button>
                        <button onclick="insertEmoji('ğŸ˜‚')">ğŸ˜‚</button>
                        <button onclick="insertEmoji('â¤ï¸')">â¤ï¸</button>
                        <button onclick="insertEmoji('ğŸ‘')">ğŸ‘</button>
                        <button onclick="insertEmoji('ğŸ‰')">ğŸ‰</button>
                        <button onclick="insertEmoji('ğŸ”¥')">ğŸ”¥</button>
                        <button onclick="insertEmoji('âœ¨')">âœ¨</button>
                        <button onclick="insertEmoji('ğŸ’¯')">ğŸ’¯</button>
                        <button onclick="insertEmoji('ğŸš€')">ğŸš€</button>
                        <button onclick="insertEmoji('â­')">â­</button>
                        <button onclick="insertEmoji('ğŸ’ª')">ğŸ’ª</button>
                        <button onclick="insertEmoji('ğŸ™')">ğŸ™</button>
                        <button onclick="insertEmoji('ğŸ˜')">ğŸ˜</button>
                        <button onclick="insertEmoji('ğŸ¤”')">ğŸ¤”</button>
                        <button onclick="insertEmoji('ğŸ‘')">ğŸ‘</button>
                        <button onclick="insertEmoji('ğŸ¯')">ğŸ¯</button>
                    </div>
                </div>
                <div class="input-wrapper">
                    <textarea 
                        id="message-input" 
                        placeholder="Tapez votre message ici..."
                        rows="1"
                        maxlength="5000"
                    ></textarea>
                    <button class="btn-send" id="send-btn" onclick="sendMessage()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
                <div class="input-hint">
                    Utilisez <kbd>Shift</kbd> + <kbd>Enter</kbd> pour un saut de ligne, <kbd>Enter</kbd> pour envoyer
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        let socket = null;
        let isConnected = false;
        const messageInput = document.getElementById('message-input');
        const messagesContainer = document.getElementById('messages');

        // Connexion au serveur
        function connectToServer() {
            const username = document.getElementById('username').value.trim();
            const serverIp = document.getElementById('server-ip').value.trim();
            const serverPort = document.getElementById('server-port').value.trim();

            if (!username) {
                alert('Veuillez entrer un nom d\'utilisateur.');
                return;
            }

            if (!serverIp || !serverPort) {
                alert('Veuillez entrer une adresse IP et un port valides.');
                return;
            }

            // Se connecter au serveur Flask local (client_web.py) qui gÃ©rera la connexion TCP
            // Le client_web.py doit tourner localement sur le port 5001
            socket = io('http://localhost:5001');

            socket.on('connect', () => {
                // Une fois connectÃ© au serveur Flask, demander la connexion TCP
                socket.emit('connect_to_server', {
                    username: username,
                    server_ip: serverIp,
                    server_port: serverPort
                });
            });

            socket.on('connected', (data) => {
                isConnected = true;
                document.getElementById('connection-panel').style.display = 'none';
                document.getElementById('chat-container').style.display = 'flex';
                document.getElementById('server-address-display').textContent = `${data.server_ip}:${data.server_port}`;
                updateConnectionStatus(true);
                addSystemMessage('ConnectÃ© au serveur');
            });

            socket.on('connection_error', (data) => {
                alert(data.message);
                isConnected = false;
                updateConnectionStatus(false);
            });

            socket.on('disconnected', (data) => {
                isConnected = false;
                updateConnectionStatus(false);
                addSystemMessage(data.reason || 'DÃ©connectÃ© du serveur');
            });

            socket.on('error', (data) => {
                addSystemMessage('Erreur: ' + data.message);
            });

            socket.on('message_received', (data) => {
                const senderName = data.server_username || 'Serveur';
                addMessage(senderName, data.message, 'received');
            });

            socket.on('message_sent', (data) => {
                addMessage('Vous', data.message, 'sent', data.message_id);
            });
            
            socket.on('message_read', (data) => {
                updateReadStatus(data.message_id, 'read');
            });
        }

        // DÃ©connexion du serveur
        function disconnectFromServer() {
            if (socket) {
                socket.emit('disconnect_from_server');
                socket.disconnect();
                socket = null;
            }
            isConnected = false;
            document.getElementById('connection-panel').style.display = 'flex';
            document.getElementById('chat-container').style.display = 'none';
            updateConnectionStatus(false);
            messagesContainer.innerHTML = `
                <div class="welcome-message">
                    <div class="welcome-icon">ğŸ‰</div>
                    <h3>ConnectÃ© avec succÃ¨s!</h3>
                    <p>Vous pouvez maintenant Ã©changer des messages avec le serveur.</p>
                </div>
            `;
        }

        // Mise Ã  jour du statut de connexion
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            const statusDot = statusElement.querySelector('.status-dot');
            const statusText = statusElement.querySelector('span:last-child');

            if (connected) {
                statusDot.classList.remove('disconnected');
                statusDot.classList.add('connected');
                statusText.textContent = 'ConnectÃ©';
            } else {
                statusDot.classList.remove('connected');
                statusDot.classList.add('disconnected');
                statusText.textContent = 'DÃ©connectÃ©';
            }
        }

        // Envoyer un message
        function sendMessage() {
            const message = messageInput.value.trim();
            
            // Validation du message
            if (!message) {
                showValidationError('Le message ne peut pas Ãªtre vide.');
                return;
            }
            
            if (message.length > 5000) {
                showValidationError('Le message ne peut pas dÃ©passer 5000 caractÃ¨res.');
                return;
            }
            
            if (!socket || !isConnected) {
                showValidationError('Vous n\'Ãªtes pas connectÃ© au serveur.');
                return;
            }
            
            socket.emit('send_message', {
                message: message
            });
            messageInput.value = '';
            updateCharCount();
            autoResize();
        }

        // Ajouter un message
        function addMessage(sender, message, type, messageId = null) {
            const welcomeMsg = messagesContainer.querySelector('.welcome-message');
            if (welcomeMsg) welcomeMsg.remove();

            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
            const dateString = now.toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit', year: 'numeric'});
            const fullTimestamp = `${dateString} ${timeString}`;

            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            if (messageId) {
                messageElement.dataset.messageId = messageId;
            }
            
            // Statut de lecture pour les messages envoyÃ©s
            const readStatus = type === 'sent' ? '<span class="read-status" data-status="sent">âœ“</span>' : '';
            
            messageElement.innerHTML = `
                <div class="message-avatar">${sender.charAt(0)}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">${sender}</span>
                        <span class="message-time">${fullTimestamp}</span>
                    </div>
                    <div class="message-text">${formatMessage(escapeHtml(message))}</div>
                    ${readStatus}
                </div>
            `;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Notification sonore pour les messages reÃ§us
            if (type === 'received') {
                playNotificationSound();
            }
            
            return messageElement;
        }

        // Ajouter un message systÃ¨me
        function addSystemMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message system';
            messageElement.innerHTML = `
                <div class="system-message">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 0a8 8 0 100 16A8 8 0 008 0zm1 12H7V7h2v5zm0-6H7V4h2v2z"/>
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Effacer les messages
        function clearMessages() {
            messagesContainer.innerHTML = `
                <div class="welcome-message">
                    <div class="welcome-icon">ğŸ’¬</div>
                    <h3>Messages effacÃ©s</h3>
                    <p>La conversation continue...</p>
                </div>
            `;
        }

        // Auto-resize textarea
        function autoResize() {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
        }

        messageInput.addEventListener('input', autoResize);

        // Gestion des touches
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Formater le message (gras, italique, emojis)
        function formatMessage(text) {
            // Gras: **texte** -> <strong>texte</strong>
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // Italique: *texte* -> <em>texte</em>
            text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
            
            // Saut de ligne
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }
        
        // Formater le texte (gras, italique)
        function formatText(format) {
            const textarea = messageInput;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            if (!selectedText) {
                alert('Veuillez sÃ©lectionner du texte Ã  formater.');
                return;
            }
            
            let formattedText = '';
            if (format === 'bold') {
                formattedText = `**${selectedText}**`;
            } else if (format === 'italic') {
                formattedText = `*${selectedText}*`;
            }
            
            textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + formattedText.length, start + formattedText.length);
            updateCharCount();
        }
        
        // Toggle emoji picker
        function toggleEmojiPicker() {
            const picker = document.getElementById('emoji-picker');
            picker.style.display = picker.style.display === 'none' ? 'grid' : 'none';
        }
        
        // InsÃ©rer un emoji
        function insertEmoji(emoji) {
            const textarea = messageInput;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            
            textarea.value = textarea.value.substring(0, start) + emoji + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + emoji.length, start + emoji.length);
            
            toggleEmojiPicker();
            updateCharCount();
        }
        
        // Mettre Ã  jour le compteur de caractÃ¨res
        function updateCharCount() {
            // Fonction dÃ©sactivÃ©e - compteur retirÃ© de l'interface
        }
        
        // Afficher une erreur de validation
        function showValidationError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'validation-error';
            errorDiv.textContent = message;
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;
            
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => errorDiv.remove(), 300);
            }, 3000);
        }
        
        // Jouer un son de notification
        function playNotificationSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }
        
        // Mettre Ã  jour le statut de lecture
        function updateReadStatus(messageId, status) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                const readStatusElement = messageElement.querySelector('.read-status');
                if (readStatusElement) {
                    readStatusElement.dataset.status = status;
                    if (status === 'read') {
                        readStatusElement.innerHTML = 'âœ“âœ“';
                        readStatusElement.style.color = '#48bb78';
                    }
                }
            }
        }
        
        // Mise Ã  jour du compteur lors de la saisie
        messageInput.addEventListener('input', () => {
            updateCharCount();
            autoResize();
        });
        
        // Raccourcis clavier pour le formatage
        messageInput.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'b') {
                e.preventDefault();
                formatText('bold');
            } else if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                formatText('italic');
            }
        });
        
        // Fermer le sÃ©lecteur d'emojis si on clique ailleurs
        document.addEventListener('click', (e) => {
            const emojiPicker = document.getElementById('emoji-picker');
            const emojiButton = e.target.closest('.btn-format');
            
            if (emojiPicker && !emojiPicker.contains(e.target) && !emojiButton) {
                emojiPicker.style.display = 'none';
            }
        });
    </script>
</body>
</html>
