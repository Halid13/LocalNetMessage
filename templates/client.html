<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalNetMessage - Client</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container client-view">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <circle cx="16" cy="16" r="14" stroke="url(#gradient)" stroke-width="2"/>
                        <circle cx="16" cy="16" r="6" fill="url(#gradient)"/>
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#667eea"/>
                                <stop offset="100%" style="stop-color:#764ba2"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    <h1>LocalNetMessage</h1>
                </div>
                <div class="connection-status" id="connection-status">
                    <span class="status-dot disconnected"></span>
                    <span>D√©connect√©</span>
                </div>
            </div>
        </header>

        <!-- Connection Panel -->
        <div class="connection-panel" id="connection-panel">
            <div class="connection-card">
                <div class="connection-icon">
                    <svg width="64" height="64" viewBox="0 0 64 64" fill="none">
                        <circle cx="32" cy="32" r="28" stroke="url(#gradient2)" stroke-width="3"/>
                        <path d="M32 20v24M20 32h24" stroke="url(#gradient2)" stroke-width="3" stroke-linecap="round"/>
                        <defs>
                            <linearGradient id="gradient2" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#667eea"/>
                                <stop offset="100%" style="stop-color:#764ba2"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <h2>Connexion au serveur</h2>
                <p>Entrez l'adresse IP du serveur pour √©tablir la connexion</p>
                
                <div class="form-group">
                    <label for="server-ip">Adresse IP du serveur</label>
                    <input 
                        type="text" 
                        id="server-ip" 
                        placeholder="127.0.0.1" 
                        value="127.0.0.1"
                        class="input-field"
                    >
                </div>
                
                <div class="form-group">
                    <label for="server-port">Port</label>
                    <input 
                        type="number" 
                        id="server-port" 
                        placeholder="12345" 
                        value="12345"
                        class="input-field"
                    >
                </div>

                <button class="btn-connect" onclick="connectToServer()">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9V7h2v6zm0-8H9V3h2v2z"/>
                    </svg>
                    Se connecter
                </button>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-container client-chat" id="chat-container" style="display: none;">
            <div class="chat-header">
                <div class="server-info-header">
                    <h2>Conversation avec le serveur</h2>
                    <span id="server-address-display"></span>
                </div>
                <div class="chat-actions">
                    <button class="btn-icon" onclick="clearMessages()" title="Effacer les messages">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/>
                        </svg>
                    </button>
                    <button class="btn-icon btn-disconnect" onclick="disconnectFromServer()" title="Se d√©connecter">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 11-2 0V4H5v12h10v-2a1 1 0 112 0v3a1 1 0 01-1 1H4a1 1 0 01-1-1V3z"/>
                            <path d="M11 10a1 1 0 011-1h4.586l-1.293-1.293a1 1 0 011.414-1.414l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L16.586 11H12a1 1 0 01-1-1z"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="messages-container" id="messages">
                <div class="welcome-message">
                    <div class="welcome-icon">üéâ</div>
                    <h3>Connect√© avec succ√®s!</h3>
                    <p>Vous pouvez maintenant √©changer des messages avec le serveur.</p>
                </div>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="message-input" 
                        placeholder="Tapez votre message ici..."
                        rows="1"
                    ></textarea>
                    <button class="btn-send" id="send-btn" onclick="sendMessage()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
                <div class="input-hint">
                    Utilisez <kbd>Shift</kbd> + <kbd>Enter</kbd> pour un saut de ligne, <kbd>Enter</kbd> pour envoyer
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        let socket = null;
        let isConnected = false;
        const messageInput = document.getElementById('message-input');
        const messagesContainer = document.getElementById('messages');

        // Connexion au serveur
        function connectToServer() {
            const serverIp = document.getElementById('server-ip').value.trim();
            const serverPort = document.getElementById('server-port').value.trim();

            if (!serverIp || !serverPort) {
                alert('Veuillez entrer une adresse IP et un port valides.');
                return;
            }

            // Se connecter au serveur Flask local qui g√©rera la connexion TCP
            socket = io('http://localhost:5001');

            socket.on('connect', () => {
                // Une fois connect√© au serveur Flask, demander la connexion TCP
                socket.emit('connect_to_server', {
                    server_ip: serverIp,
                    server_port: serverPort
                });
            });

            socket.on('connected', (data) => {
                isConnected = true;
                document.getElementById('connection-panel').style.display = 'none';
                document.getElementById('chat-container').style.display = 'flex';
                document.getElementById('server-address-display').textContent = `${data.server_ip}:${data.server_port}`;
                updateConnectionStatus(true);
                addSystemMessage('Connect√© au serveur');
            });

            socket.on('connection_error', (data) => {
                alert(data.message);
                isConnected = false;
                updateConnectionStatus(false);
            });

            socket.on('disconnected', (data) => {
                isConnected = false;
                updateConnectionStatus(false);
                addSystemMessage(data.reason || 'D√©connect√© du serveur');
            });

            socket.on('error', (data) => {
                addSystemMessage('Erreur: ' + data.message);
            });

            socket.on('message_received', (data) => {
                addMessage('Serveur', data.message, 'received');
            });

            socket.on('message_sent', (data) => {
                addMessage('Vous', data.message, 'sent');
            });
        }

        // D√©connexion du serveur
        function disconnectFromServer() {
            if (socket) {
                socket.emit('disconnect_from_server');
                socket.disconnect();
                socket = null;
            }
            isConnected = false;
            document.getElementById('connection-panel').style.display = 'flex';
            document.getElementById('chat-container').style.display = 'none';
            updateConnectionStatus(false);
            messagesContainer.innerHTML = `
                <div class="welcome-message">
                    <div class="welcome-icon">üéâ</div>
                    <h3>Connect√© avec succ√®s!</h3>
                    <p>Vous pouvez maintenant √©changer des messages avec le serveur.</p>
                </div>
            `;
        }

        // Mise √† jour du statut de connexion
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            const statusDot = statusElement.querySelector('.status-dot');
            const statusText = statusElement.querySelector('span:last-child');

            if (connected) {
                statusDot.classList.remove('disconnected');
                statusDot.classList.add('connected');
                statusText.textContent = 'Connect√©';
            } else {
                statusDot.classList.remove('connected');
                statusDot.classList.add('disconnected');
                statusText.textContent = 'D√©connect√©';
            }
        }

        // Envoyer un message
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && socket && isConnected) {
                socket.emit('send_message', {
                    message: message
                });
                messageInput.value = '';
                autoResize();
            }
        }

        // Ajouter un message
        function addMessage(sender, message, type) {
            const welcomeMsg = messagesContainer.querySelector('.welcome-message');
            if (welcomeMsg) welcomeMsg.remove();

            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.innerHTML = `
                <div class="message-avatar">${sender.charAt(0)}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">${sender}</span>
                        <span class="message-time">${new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</span>
                    </div>
                    <div class="message-text">${escapeHtml(message)}</div>
                </div>
            `;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Ajouter un message syst√®me
        function addSystemMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message system';
            messageElement.innerHTML = `
                <div class="system-message">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 0a8 8 0 100 16A8 8 0 008 0zm1 12H7V7h2v5zm0-6H7V4h2v2z"/>
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Effacer les messages
        function clearMessages() {
            messagesContainer.innerHTML = `
                <div class="welcome-message">
                    <div class="welcome-icon">üí¨</div>
                    <h3>Messages effac√©s</h3>
                    <p>La conversation continue...</p>
                </div>
            `;
        }

        // Auto-resize textarea
        function autoResize() {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
        }

        messageInput.addEventListener('input', autoResize);

        // Gestion des touches
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
