<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalNetMessage - Serveur</title>
    <link rel="icon" href="/assets/favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/modern-overrides.css">
    <link rel="stylesheet" href="/static/themes.css">
    <link rel="stylesheet" href="/static/theme-selector.css">
    <link rel="stylesheet" href="/static/encryption-ui.css">
</head>
<body>
    <!-- Page d'accueil avec formulaire de username -->
    <div class="welcome-page" id="welcome-page">
        <div class="welcome-container">
            <div class="welcome-hero">
                <div class="welcome-logo">
                    <svg width="120" height="120" viewBox="0 0 120 120" fill="none">
                        <circle cx="60" cy="60" r="50" stroke="url(#welcomeGradient)" stroke-width="4"/>
                        <circle cx="60" cy="60" r="20" fill="url(#welcomeGradient)"/>
                        <circle cx="60" cy="60" r="35" stroke="url(#welcomeGradient)" stroke-width="2" opacity="0.5"/>
                        <defs>
                            <linearGradient id="welcomeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#667eea"/>
                                <stop offset="100%" style="stop-color:#764ba2"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <h1 class="welcome-title">LocalNetMessage</h1>
                <p class="welcome-subtitle">Messagerie instantan√©e sur r√©seau local</p>
                <div class="welcome-features">
                    <div class="feature-item">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        <span>Communication s√©curis√©e</span>
                    </div>
                    <div class="feature-item">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                        </svg>
                        <span>Messages en temps r√©el</span>
                    </div>
                    <div class="feature-item">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                        </svg>
                        <span>Interface moderne</span>
                    </div>
                </div>
            </div>
            
            <div class="welcome-form-card">
                <h2>Configurer le serveur</h2>
                <p class="form-description">Choisissez un nom d'utilisateur qui sera affich√© lors des conversations avec les clients</p>
                
                <div class="form-group">
                    <label for="server-username">Nom d'utilisateur du serveur</label>
                    <div class="input-icon-wrapper">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" class="input-icon">
                            <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                        </svg>
                        <input 
                            type="text" 
                            id="server-username" 
                            class="input-field"
                            placeholder="Ex: Admin, Support, Serveur..."
                            required
                            maxlength="30"
                        >
                    </div>
                    <small class="input-hint-text">Ce nom sera visible par tous les clients connect√©s</small>
                </div>

                <button class="btn-start-server" onclick="startServer()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    D√©marrer le serveur
                </button>
            </div>
        </div>
    </div>

    <!-- Interface principale du serveur (cach√©e au d√©part) -->
    <div class="container" id="server-container" style="display: none;">
        <!-- Header -->
        <header class="header server-header">
            <div class="header-main">
                <div class="header-left">
                    <div class="logo-pill">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                            <circle cx="16" cy="16" r="14" stroke="url(#gradient)" stroke-width="2"/>
                            <circle cx="16" cy="16" r="6" fill="url(#gradient)"/>
                            <defs>
                                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#667eea"/>
                                    <stop offset="100%" style="stop-color:#764ba2"/>
                                </linearGradient>
                            </defs>
                        </svg>
                        <div>
                            <div class="logo-title">LocalNetMessage</div>
                            <div class="logo-sub">Console serveur</div>
                        </div>
                    </div>
                    <div class="server-badge pill">
                        <span class="status-dot"></span>
                        <div class="badge-text">
                            <span>Serveur</span>
                            <strong id="server-username-display"></strong>
                            <span class="status-text" id="server-status-display">Disponible</span>
                        </div>
                    </div>
                </div>

                <div class="header-center">
                    <div class="info-chip" id="server-address">Serveur: 127.0.0.1:12345</div>
                    <div class="info-chip" id="active-connections">Connexions actives: <strong>0</strong></div>
                </div>

                <div class="header-actions">
                    <div class="theme-selector-wrapper">
                        <button class="theme-selector-btn" id="theme-menu-btn" onclick="toggleThemeMenu()" aria-label="S√©lectionner un th√®me" title="Th√®mes">
                            üé®
                        </button>
                        <div class="theme-menu" id="theme-menu" style="display: none;">
                            <div class="theme-option" onclick="setTheme('violet')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)" title="Violet"></div>
                            <div class="theme-option" onclick="setTheme('rose')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%)" title="Rose"></div>
                            <div class="theme-option" onclick="setTheme('cyan')" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)" title="Cyan"></div>
                            <div class="theme-option" onclick="setTheme('green')" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)" title="Vert"></div>
                            <div class="theme-option" onclick="setTheme('orange')" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%)" title="Orange"></div>
                            <div class="theme-option" onclick="setTheme('turquoise')" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%)" title="Turquoise"></div>
                            <div class="theme-option" onclick="setTheme('peach')" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)" title="P√™che"></div>
                            <div class="theme-option" onclick="setTheme('indigo')" style="background: linear-gradient(135deg, #667eea 0%, #5568d3 100%)" title="Indigo"></div>
                            <div class="theme-option" onclick="setTheme('coral')" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)" title="Corail"></div>
                        </div>
                    </div>
                    <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" aria-label="Changer le th√®me"></button>
                    <button class="btn-icon" id="profile-btn" title="Profil utilisateur">üë§</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar - Clients List -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h2>Clients Connect√©s</h2>
                    <span class="client-count" id="client-count">0</span>
                </div>
                <div class="clients-list" id="clients-list">
                    <div class="empty-state">
                        <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                            <circle cx="24" cy="24" r="20" stroke="#e0e7ff" stroke-width="2"/>
                            <path d="M24 14v20M14 24h20" stroke="#e0e7ff" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <p>En attente de connexions...</p>
                    </div>
                </div>
            </aside>

            <!-- Chat Area -->
            <div class="chat-container">
                <div class="chat-header">
                    <h2>Conversation</h2>
                    <div class="chat-actions">
                        <input type="file" id="file-input" style="display:none" />
                        <button class="btn-icon" onclick="document.getElementById('file-input').click()" title="Envoyer un fichier">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M14.59 2.59a2 2 0 012.82 0l4 4a2 2 0 010 2.82l-9.17 9.17a4 4 0 01-5.66-5.66L14 7.41a1 1 0 111.41 1.41l-6.59 6.59a2 2 0 102.83 2.83L21.17 7 17 2.83 14.59 5.24 13.17 3.83l1.42-1.24z"/>
                            </svg>
                        </button>
                        <button class="btn-icon" onclick="clearMessages()" title="Effacer les messages">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="messages-container" id="messages">
                    <div class="welcome-message">
                        <div class="welcome-icon">üí¨</div>
                        <h3>Bienvenue sur LocalNetMessage</h3>
                        <p>Le serveur est pr√™t √† recevoir des connexions.<br>Les messages appara√Ætront ici.</p>
                    </div>
                </div>

                <div class="input-container">
                    <div class="selected-client" id="selected-client">
                        <span>S√©lectionnez un client pour r√©pondre</span>
                    </div>
                    <div class="formatting-toolbar">
                        <button class="btn-format" onclick="insertFormatting('**')" title="Gras">
                            <strong>B</strong>
                        </button>
                        <button class="btn-format" onclick="insertFormatting('*')" title="Italique">
                            <em>I</em>
                        </button>
                        <button class="btn-format" onclick="toggleEmojiPicker()" title="√âmojis">
                            üòä
                        </button>
                    </div>
                    <div class="emoji-picker" id="emoji-picker" style="display: none;">
                        <div class="emoji-grid">
                            <span class="emoji-item" onclick="insertEmoji('üòä')">üòä</span>
                            <span class="emoji-item" onclick="insertEmoji('üòÇ')">üòÇ</span>
                            <span class="emoji-item" onclick="insertEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                            <span class="emoji-item" onclick="insertEmoji('üëç')">üëç</span>
                            <span class="emoji-item" onclick="insertEmoji('üéâ')">üéâ</span>
                            <span class="emoji-item" onclick="insertEmoji('üî•')">üî•</span>
                            <span class="emoji-item" onclick="insertEmoji('‚úÖ')">‚úÖ</span>
                            <span class="emoji-item" onclick="insertEmoji('‚ùå')">‚ùå</span>
                            <span class="emoji-item" onclick="insertEmoji('üöÄ')">üöÄ</span>
                            <span class="emoji-item" onclick="insertEmoji('üí°')">üí°</span>
                            <span class="emoji-item" onclick="insertEmoji('‚ö†Ô∏è')">‚ö†Ô∏è</span>
                            <span class="emoji-item" onclick="insertEmoji('üìù')">üìù</span>
                            <span class="emoji-item" onclick="insertEmoji('üí¨')">üí¨</span>
                            <span class="emoji-item" onclick="insertEmoji('ü§î')">ü§î</span>
                            <span class="emoji-item" onclick="insertEmoji('üòé')">üòé</span>
                            <span class="emoji-item" onclick="insertEmoji('üôè')">üôè</span>
                        </div>
                    </div>
                    <div class="input-wrapper">
                        <textarea 
                            id="message-input" 
                            placeholder="Tapez votre message ici..."
                            rows="1"
                            disabled
                        ></textarea>
                        <button class="btn-send" id="send-btn" onclick="sendMessage()" disabled>
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="input-hint">
                        Utilisez <kbd>Shift</kbd> + <kbd>Enter</kbd> pour un saut de ligne, <kbd>Enter</kbd> pour envoyer
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        let socket;
        let selectedClient = null;
        let clientConversations = {};
        let messageInput;
        let sendBtn;
        let messagesContainer;
        let serverUsername = '';
        
        const notificationSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjGH0fPTgjMGHm7A7+OZURE');

        function startServer() {
            console.log('startServer() appel√©e');
            const usernameInput = document.getElementById('server-username');
            const username = usernameInput.value.trim();
            
            console.log('Username saisi:', username);
            
            if (!username) {
                alert('Veuillez entrer un nom d\'utilisateur pour le serveur.');
                usernameInput.focus();
                return;
            }
            
            if (username.length < 2) {
                alert('Le nom d\'utilisateur doit contenir au moins 2 caract√®res.');
                usernameInput.focus();
                return;
            }
            
            serverUsername = username;
            
            console.log('Envoi de la requ√™te au serveur...');
            
            fetch('/set_server_username', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username: username })
            })
            .then(response => {
                console.log('R√©ponse re√ßue:', response);
                return response.json();
            })
            .then(data => {
                console.log('Donn√©es re√ßues:', data);
                if (data.success) {
                    document.getElementById('welcome-page').style.display = 'none';
                    document.getElementById('server-container').style.display = 'flex';
                    document.getElementById('server-username-display').textContent = username;
                    
                    messageInput = document.getElementById('message-input');
                    sendBtn = document.getElementById('send-btn');
                    messagesContainer = document.getElementById('messages');
                    
                    socket = io();
                    initializeSocketEvents();
                    
                    messageInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            sendMessage();
                        }
                    });
                    
                    messageInput.addEventListener('input', autoResize);
                    
                    console.log('Interface serveur initialis√©e avec succ√®s');
                }
            })
            .catch(error => {
                console.error('Erreur lors du d√©marrage:', error);
                alert('Erreur lors du d√©marrage du serveur: ' + error.message);
            });
        }
        
        function initializeSocketEvents() {
            socket.on('connect', () => {
                console.log('Connect√© au serveur WebSocket');
            });

            socket.on('client_connected', (data) => {
                addClientToList(data.client_id, data.username, data.address);
                updateConnectionCount();
                
                if (!clientConversations[data.client_id]) {
                    clientConversations[data.client_id] = [];
                }
                
                clientConversations[data.client_id].push({
                    type: 'system',
                    message: `${data.username} (${data.address}) connect√©`
                });
            });

            socket.on('client_renamed', (data) => {
                const item = document.getElementById(`client-${data.client_id}`);
                if (item) {
                    const nameEl = item.querySelector('.client-name');
                    if (nameEl) nameEl.textContent = data.username;
                }
                if (clientConversations[data.client_id]) {
                    clientConversations[data.client_id].push({
                        type: 'system',
                        message: `Nom mis √† jour: ${data.username}`
                    });
                }
                if (selectedClient === data.client_id) {
                    updateSelectedClient();
                    
                    const receivedMessages = messagesContainer.querySelectorAll('.message.received .message-sender');
                    receivedMessages.forEach((senderEl) => {
                        senderEl.textContent = data.username;
                    });
                    
                    addMessageToDisplay('Syst√®me', `${data.username} a chang√© son nom.`, 'system');
                }
            });

            socket.on('client_disconnected', (data) => {
                if (clientConversations[data.client_id]) {
                    clientConversations[data.client_id].push({
                        type: 'system',
                        message: `${data.username} (${data.address}) d√©connect√©`
                    });
                }
                
                removeClientFromList(data.client_id);
                updateConnectionCount();
                
                if (selectedClient === data.client_id) {
                    selectedClient = null;
                    updateSelectedClient();
                    showWelcomeMessage();
                }
            });

            socket.on('server_username_updated', (data) => {
                const el = document.getElementById('server-username-display');
                if (el && data.username) el.textContent = data.username;
            });

            socket.on('server_status_updated', (data) => {
                const el = document.getElementById('server-status-display');
                if (el && data.status) {
                    el.textContent = data.status;
                    updateStatusIndicator(data.status);
                }
            });

            socket.on('server_avatar_updated', (data) => {
                if (data.avatar) {
                    // Mettre √† jour le localStorage du serveur
                    const serverProfile = JSON.parse(localStorage.getItem('serverProfile') || '{"avatar":"üôÇ"}');
                    serverProfile.avatar = data.avatar;
                    localStorage.setItem('serverProfile', JSON.stringify(serverProfile));
                    updateServerProfileButton(data.avatar);
                }
            });

            socket.on('client_status_changed', (data) => {
                const item = document.getElementById(`client-${data.client_id}`);
                if (item) {
                    const statusEl = item.querySelector('.client-status');
                    if (statusEl) {
                        statusEl.textContent = data.status;
                        statusEl.className = `client-status status-${getStatusClass(data.status)}`;
                    }
                }
                if (clientConversations[data.client_id]) {
                    clientConversations[data.client_id].push({
                        type: 'system',
                        message: `Statut: ${data.status}`
                    });
                }
                if (selectedClient === data.client_id) {
                    addMessageToDisplay('Syst√®me', `${data.username} est maintenant ${data.status}`, 'system');
                }
            });

            socket.on('client_avatar_changed', (data) => {
                // Mettre √† jour les clients disponibles
                if (clients[data.client_id]) {
                    clients[data.client_id].avatar = data.avatar;
                }
                
                // Ajouter dans l'historique
                if (clientConversations[data.client_id]) {
                    clientConversations[data.client_id].push({
                        type: 'system',
                        message: `Avatar mis √† jour`
                    });
                }
                
                // Si ce client est actuellement s√©lectionn√©, afficher le changement
                if (selectedClient === data.client_id) {
                    addMessageToDisplay('Syst√®me', `${data.username} a chang√© d'avatar`, 'system');
                }
            });

            socket.on('message_received', (data) => {
                if (!clientConversations[data.client_id]) {
                    clientConversations[data.client_id] = [];
                }
                
                let messageContent = data.message;
                if (encryption && data.message.startsWith('[ENCRYPTED]')) {
                    try {
                        messageContent = encryption.decrypt(data.message);
                    } catch (e) {
                        console.warn('Impossible de d√©chiffrer le message:', e);
                        messageContent = '[Message chiffr√© - cl√© introuvable]';
                    }
                }
                
                clientConversations[data.client_id].push({
                    type: 'received',
                    sender: data.username,
                    message: messageContent,
                    read: false,
                    timestamp: new Date().toLocaleString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit', 
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                });
                
                if (selectedClient === data.client_id) {
                    addMessageToDisplay(data.username, messageContent, 'received');
                    markClientMessagesAsRead(data.client_id);
                } else {
                    showNotification(data.client_id);
                    playNotificationSound();
                }
                
                if (!selectedClient) {
                    selectClient(data.client_id);
                }
            });

            socket.on('message_sent', (data) => {
                if (!clientConversations[data.client_id]) {
                    clientConversations[data.client_id] = [];
                }
            
                let messageToStore = data.message;
                if (encryption && data.message.startsWith('[ENCRYPTED]')) {
                    try {
                        messageToStore = encryption.decrypt(data.message);
                    } catch (e) {
                        console.warn('Message chiffr√© non d√©chiffrable');
                        messageToStore = '[Message chiffr√© - affichage original]';
                    }
                }
            
                clientConversations[data.client_id].push({
                    type: 'sent',
                    sender: 'Vous',
                    message: messageToStore,
                    read: false,
                    timestamp: new Date().toLocaleString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                });
                
                if (selectedClient === data.client_id) {
                    addMessageToDisplay('Vous', messageToStore, 'sent');
                }
            });

            socket.on('clients_update', (data) => {
                data.clients.forEach(client => {
                    if (!clientConversations[client.id]) {
                        clientConversations[client.id] = [];
                    }
                });
                updateClientsList(data.clients);
                updateConnectionCount();
            });

            socket.on('file_received', (data) => {
                if (!clientConversations[data.client_id]) {
                    clientConversations[data.client_id] = [];
                }
                const info = `[Fichier] ${data.filename} (${Math.round(data.size/1024)} Ko)`;
                clientConversations[data.client_id].push({
                    type: 'received',
                    sender: data.username,
                    message: info,
                    read: false,
                    timestamp: new Date().toLocaleString('fr-FR')
                });
                if (selectedClient === data.client_id) {
                    addFileToDisplay(data.username, data.filename, data.url, 'received');
                    markClientMessagesAsRead(data.client_id);
                } else {
                    showNotification(data.client_id);
                    playNotificationSound();
                }
            });

            socket.on('file_sent', (data) => {
                if (!clientConversations[data.client_id]) {
                    clientConversations[data.client_id] = [];
                }
                const info = `[Fichier] ${data.filename} (${Math.round(data.size/1024)} Ko)`;
                clientConversations[data.client_id].push({
                    type: 'sent',
                    sender: 'Vous',
                    message: info,
                    read: false,
                    timestamp: new Date().toLocaleString('fr-FR')
                });
                if (selectedClient === data.client_id) {
                    const url = `/files/server/sent/${data.client_id}/${data.filename}`;
                    addFileToDisplay('Vous', data.filename, url, 'sent');
                }
            });
        }

        function addClientToList(clientId, username, address) {
            const clientsList = document.getElementById('clients-list');
            const emptyState = clientsList.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const clientElement = document.createElement('div');
            clientElement.className = 'client-item';
            clientElement.id = `client-${clientId}`;
            clientElement.onclick = () => selectClient(clientId);
            clientElement.innerHTML = `
                <div class="client-avatar">${username.charAt(0).toUpperCase()}</div>
                <div class="client-info">
                    <div class="client-name">${username}</div>
                    <div class="client-address">${address}</div>
                    <div class="client-status status-disponible">Disponible</div>
                </div>
                <span class="notification-badge" id="badge-${clientId}" style="display: none;">0</span>
            `;
            clientsList.appendChild(clientElement);
        }

        function removeClientFromList(clientId) {
            const clientElement = document.getElementById(`client-${clientId}`);
            if (clientElement) {
                clientElement.remove();
            }
            const clientsList = document.getElementById('clients-list');
            if (clientsList.children.length === 0) {
                clientsList.innerHTML = `
                    <div class="empty-state">
                        <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                            <circle cx="24" cy="24" r="20" stroke="#e0e7ff" stroke-width="2"/>
                            <path d="M24 14v20M14 24h20" stroke="#e0e7ff" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <p>En attente de connexions...</p>
                    </div>
                `;
            }
        }

        function selectClient(clientId) {
            selectedClient = clientId;
            document.querySelectorAll('.client-item').forEach(el => {
                el.classList.remove('active');
            });
            const clientElement = document.getElementById(`client-${clientId}`);
            if (clientElement) {
                clientElement.classList.add('active');
                const username = clientElement.querySelector('.client-name').textContent;
                document.getElementById('selected-client').innerHTML = `
                    <span>R√©pondre √†: <strong>${username}</strong></span>
                `;
                messageInput.disabled = false;
                sendBtn.disabled = false;
                messageInput.focus();
                
                loadClientConversation(clientId);
            }
        }
        
        function loadClientConversation(clientId) {
            messagesContainer.innerHTML = '';
            
            hideNotification(clientId);
            
            markClientMessagesAsRead(clientId);
            
            if (!clientConversations[clientId] || clientConversations[clientId].length === 0) {
                showWelcomeMessage();
                return;
            }
            
            clientConversations[clientId].forEach(msg => {
                if (msg.type === 'system') {
                    addSystemMessageToDisplay(msg.message);
                } else {
                    addMessageToDisplay(msg.sender, msg.message, msg.type, msg.timestamp, msg.read);
                }
            });
        }
        
        function markClientMessagesAsRead(clientId) {
            if (clientConversations[clientId]) {
                clientConversations[clientId].forEach(msg => {
                    if (msg.type === 'received') {
                        msg.read = true;
                    }
                });
                
                socket.emit('mark_messages_read', { client_id: clientId });
            }
        }

        function updateSelectedClient() {
            if (!selectedClient) {
                document.getElementById('selected-client').innerHTML = `
                    <span>S√©lectionnez un client pour r√©pondre</span>
                `;
                messageInput.disabled = true;
                sendBtn.disabled = true;
            } else {
                const clientElement = document.getElementById(`client-${selectedClient}`);
                if (clientElement) {
                    const username = clientElement.querySelector('.client-name').textContent;
                    document.getElementById('selected-client').innerHTML = `
                        <span>R√©pondre √†: <strong>${username}</strong></span>
                    `;
                }
            }
        }

        function getServerProfile() {
            try {
                const raw = localStorage.getItem('serverProfile');
                return raw ? JSON.parse(raw) : { avatar: 'üôÇ' };
            } catch { return { avatar: 'üôÇ' }; }
        }

        function serverAvatarMarkup(sender, type) {
            const profile = getServerProfile();
            const avatar = (type === 'sent' && profile && profile.avatar) ? profile.avatar : '';
            const initial = sender && sender.charAt ? sender.charAt(0) : '?';
            if (avatar && (avatar.startsWith('http://') || avatar.startsWith('https://') || avatar.startsWith('data:image/'))) {
                return `<div class="message-avatar"><img src="${avatar}" alt="avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"/></div>`;
            }
            if (avatar && avatar.length <= 4 && /\p{Emoji}/u.test(avatar)) {
                return `<div class="message-avatar" style="display:flex;align-items:center;justify-content:center;font-size:14px;">${avatar}</div>`;
            }
            return `<div class="message-avatar">${initial}</div>`;
        }

        function addMessageToDisplay(sender, message, type, timestamp, read) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            
            const time = timestamp || new Date().toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let readStatus = '';
            if (type === 'sent') {
                readStatus = read 
                    ? '<span class="read-status read">‚úì‚úì</span>' 
                    : '<span class="read-status">‚úì</span>';
            }
            
            const avatarHTML = serverAvatarMarkup(sender, type);
            messageElement.innerHTML = `
                ${avatarHTML}
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">${sender}</span>
                        <span class="message-time">${time} ${readStatus}</span>
                    </div>
                    <div class="message-text">${formatMessage(escapeHtml(message))}</div>
                </div>
            `;
            messageElement.classList.add('message-enter');
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addFileToDisplay(sender, filename, url, type) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            const time = new Date().toLocaleString('fr-FR');
            const avatarHTML = serverAvatarMarkup(sender, type);
            messageElement.innerHTML = `
                ${avatarHTML}
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">${sender}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">
                        <a href="${url}" target="_blank" download>${filename}</a>
                    </div>
                </div>
            `;
            messageElement.classList.add('message-enter');
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addSystemMessageToDisplay(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message system';
            messageElement.innerHTML = `
                <div class="system-message">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 0a8 8 0 100 16A8 8 0 008 0zm1 12H7V7h2v5zm0-6H7V4h2v2z"/>
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            messageElement.classList.add('message-enter');
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showWelcomeMessage() {
            messagesContainer.innerHTML = `
                <div class="welcome-message">
                    <div class="welcome-icon">üí¨</div>
                    <h3>Bienvenue sur LocalNetMessage</h3>
                    <p>S√©lectionnez un client pour commencer la conversation.</p>
                </div>
            `;
        }

        function showNotification(clientId) {
            const badge = document.getElementById(`badge-${clientId}`);
            const clientItem = document.getElementById(`client-${clientId}`);
            
            if (badge) {
                let count = parseInt(badge.textContent) || 0;
                count++;
                badge.textContent = count;
                badge.style.display = 'flex';
            }
            
            if (clientItem) {
                clientItem.classList.add('has-notification');
            }
        }

        function hideNotification(clientId) {
            const badge = document.getElementById(`badge-${clientId}`);
            const clientItem = document.getElementById(`client-${clientId}`);
            
            if (badge) {
                badge.textContent = '0';
                badge.style.display = 'none';
            }
            
            if (clientItem) {
                clientItem.classList.remove('has-notification');
            }
        }

        function playNotificationSound() {
            notificationSound.play().catch(err => {
                console.log('Impossible de jouer le son:', err);
            });
        }

        function addMessage(clientId, sender, message, type) {
            addMessageToDisplay(sender, message, type);
        }

        function addSystemMessage(message) {
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            
            if (!message) {
                alert('Le message ne peut pas √™tre vide.');
                return;
            }
            
            if (message.length > 5000) {
                alert('Le message est trop long (maximum 5000 caract√®res).');
                return;
            }
            
            if (!selectedClient) {
                alert('S√©lectionnez un client pour envoyer un message.');
                return;
            }
            
            let messageToSend = message;
            if (encryption && encryption.isEnabled()) {
                messageToSend = encryption.encrypt(message);
            }
            
            socket.emit('send_message', {
                client_id: selectedClient,
                message: messageToSend
            });
            messageInput.value = '';
            autoResize();
        }

        document.getElementById('file-input').addEventListener('change', (e) => {
            if (!selectedClient) {
                alert('S√©lectionnez un client pour envoyer un fichier.');
                e.target.value = '';
                return;
            }
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) {
                alert('Fichier trop volumineux (max 2 Mo).');
                e.target.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = () => {
                const b64 = (reader.result || '').toString().split(',')[1] || '';
                console.log('Serveur: envoi fichier', file.name, file.type, file.size, '-> client', selectedClient);
                socket.emit('send_file', {
                    client_id: selectedClient,
                    filename: file.name,
                    mimetype: file.type || 'application/octet-stream',
                    data_base64: b64
                });
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        });

        function clearMessages() {
            if (selectedClient && clientConversations[selectedClient]) {
                clientConversations[selectedClient] = [];
                messagesContainer.innerHTML = `
                    <div class="welcome-message">
                        <div class="welcome-icon">üí¨</div>
                        <h3>Conversation effac√©e</h3>
                        <p>L'historique a √©t√© supprim√© pour ce client.</p>
                    </div>
                `;
            } else {
                showWelcomeMessage();
            }
        }

        function updateConnectionCount() {
            const count = document.querySelectorAll('.client-item').length;
            document.getElementById('client-count').textContent = count;
            document.querySelector('#active-connections strong').textContent = count;
        }

        function getStatusClass(status) {
            const statusMap = {
                'Disponible': 'disponible',
                'Occup√©': 'occupe',
                'En pause': 'pause'
            };
            return statusMap[status] || 'disponible';
        }

        function updateStatusIndicator(status) {
            const statusDot = document.querySelector('.server-badge .status-dot');
            if (statusDot) {
                statusDot.className = 'status-dot status-' + getStatusClass(status);
            }
        }

        function updateServerProfileButton() {
            const profileBtn = document.querySelector('.server-badge button[title="Profil"]');
            if (!profileBtn) return;
            
            const serverProfile = JSON.parse(localStorage.getItem('serverProfile') || '{"avatar":"üôÇ"}');
            const avatar = serverProfile.avatar || 'üôÇ';
            
            // Check if it's a data URL or image URL
            if (avatar.startsWith('data:image/') || avatar.startsWith('http://') || avatar.startsWith('https://')) {
                // Create and display image
                profileBtn.innerHTML = `<img src="${avatar}" alt="Avatar" style="width: 20px; height: 20px; object-fit: cover; border-radius: 50%; display: block;">`;
                profileBtn.style.padding = '2px';
            } else {
                // Display emoji
                profileBtn.textContent = avatar;
                profileBtn.style.padding = '5px 8px';
            }
        }

        function autoResize() {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatMessage(text) {
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
            
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }
        
        function insertFormatting(symbol) {
            const start = messageInput.selectionStart;
            const end = messageInput.selectionEnd;
            const selectedText = messageInput.value.substring(start, end);
            
            if (selectedText) {
                const newText = messageInput.value.substring(0, start) + 
                               symbol + selectedText + symbol + 
                               messageInput.value.substring(end);
                messageInput.value = newText;
                messageInput.focus();
                messageInput.setSelectionRange(start + symbol.length, end + symbol.length);
            } else {
                const newText = messageInput.value.substring(0, start) + 
                               symbol + symbol + 
                               messageInput.value.substring(end);
                messageInput.value = newText;
                messageInput.focus();
                messageInput.setSelectionRange(start + symbol.length, start + symbol.length);
            }
        }
        
        function toggleEmojiPicker() {
            const picker = document.getElementById('emoji-picker');
            picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
        }
        
        function insertEmoji(emoji) {
            const start = messageInput.selectionStart;
            const end = messageInput.selectionEnd;
            
            messageInput.value = messageInput.value.substring(0, start) + 
                                emoji + 
                                messageInput.value.substring(end);
            
            messageInput.focus();
            messageInput.setSelectionRange(start + emoji.length, start + emoji.length);
            
            document.getElementById('emoji-picker').style.display = 'none';
        }
        
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark');
            } else {
                document.body.classList.remove('dark');
            }
            updateThemeToggleIcon();
        }
        function updateThemeToggleIcon() {
            const btn = document.getElementById('theme-toggle');
            if (!btn) return;
            const isDark = document.body.classList.contains('dark');
            btn.innerHTML = isDark ? '<span class="icon-moon">üåô</span>' : '<span class="icon-sun">‚òÄÔ∏è</span>';
        }
        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeToggleIcon();
        }
        function initTheme() {
            const saved = localStorage.getItem('theme');
            if (saved) applyTheme(saved);
            else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) applyTheme('dark');
            else applyTheme('light');
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page charg√©e, initialisation...');
            initTheme();
            
            const usernameInput = document.getElementById('server-username');
            if (usernameInput) {
                usernameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        startServer();
                    }
                });
                
                usernameInput.focus();
            }
            
            initColorTheme();
            updateServerProfileButton();
            
            const savedColorTheme = localStorage.getItem('colorTheme') || 'violet';
            setTheme(savedColorTheme);
        });

        function setTheme(themeName) {
            const html = document.documentElement;
            const allThemes = ['violet', 'rose', 'cyan', 'green', 'orange', 'turquoise', 'peach', 'indigo', 'coral'];
            
            html.classList.add('theme-transitioning');
            
            allThemes.forEach(theme => html.classList.remove(`theme-${theme}`));
            
            html.classList.add(`theme-${themeName}`);
            
            updateThemeSelection(themeName);
            
            localStorage.setItem('colorTheme', themeName);
            
            setTimeout(() => html.classList.remove('theme-transitioning'), 300);
        }
        
        function toggleThemeMenu() {
            const menu = document.getElementById('theme-menu');
            if (menu) {
                menu.style.display = menu.style.display === 'none' ? 'grid' : 'none';
            }
        }
        
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('theme-menu');
            const btn = document.getElementById('theme-menu-btn');
            if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.style.display = 'none';
            }
        });
        
        function updateThemeSelection(themeName) {
            const options = document.querySelectorAll('.theme-option');
            options.forEach(opt => opt.classList.remove('active'));
            const activeOption = document.querySelector(`.theme-option[onclick*="'${themeName}'"]`);
            if (activeOption) activeOption.classList.add('active');
        }
        
        function initColorTheme() {
            const savedTheme = localStorage.getItem('colorTheme') || 'violet';
            setTheme(savedTheme);
        }
    </script>
    
    <!-- Scripts de chiffrement -->
    <script src="/static/encryption.js"></script>
    <script src="/static/encryption-ui.js"></script>
    <!-- Profil utilisateur -->
    <script src="/static/profile.js"></script>
</body>
</html>
