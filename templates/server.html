<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalNetMessage - Serveur</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <circle cx="16" cy="16" r="14" stroke="url(#gradient)" stroke-width="2"/>
                        <circle cx="16" cy="16" r="6" fill="url(#gradient)"/>
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#667eea"/>
                                <stop offset="100%" style="stop-color:#764ba2"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    <h1>LocalNetMessage</h1>
                </div>
                <div class="server-badge">
                    <span class="status-dot"></span>
                    <span>Serveur Actif</span>
                </div>
            </div>
            <div class="server-info">
                <span id="server-address">Serveur: 127.0.0.1:12345</span>
                <span id="active-connections">Connexions actives: <strong>0</strong></span>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar - Clients List -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h2>Clients Connect√©s</h2>
                    <span class="client-count" id="client-count">0</span>
                </div>
                <div class="clients-list" id="clients-list">
                    <div class="empty-state">
                        <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                            <circle cx="24" cy="24" r="20" stroke="#e0e7ff" stroke-width="2"/>
                            <path d="M24 14v20M14 24h20" stroke="#e0e7ff" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <p>En attente de connexions...</p>
                    </div>
                </div>
            </aside>

            <!-- Chat Area -->
            <div class="chat-container">
                <div class="chat-header">
                    <h2>Conversation</h2>
                    <div class="chat-actions">
                        <button class="btn-icon" onclick="clearMessages()" title="Effacer les messages">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="messages-container" id="messages">
                    <div class="welcome-message">
                        <div class="welcome-icon">üí¨</div>
                        <h3>Bienvenue sur LocalNetMessage</h3>
                        <p>Le serveur est pr√™t √† recevoir des connexions.<br>Les messages appara√Ætront ici.</p>
                    </div>
                </div>

                <div class="input-container">
                    <div class="selected-client" id="selected-client">
                        <span>S√©lectionnez un client pour r√©pondre</span>
                    </div>
                    <div class="input-wrapper">
                        <textarea 
                            id="message-input" 
                            placeholder="Tapez votre message ici..."
                            rows="1"
                            disabled
                        ></textarea>
                        <button class="btn-send" id="send-btn" onclick="sendMessage()" disabled>
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="input-hint">
                        Utilisez <kbd>Shift</kbd> + <kbd>Enter</kbd> pour un saut de ligne, <kbd>Enter</kbd> pour envoyer
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const socket = io();
        let selectedClient = null;
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const messagesContainer = document.getElementById('messages');

        // Connexion √©tablie
        socket.on('connect', () => {
            console.log('Connect√© au serveur WebSocket');
        });

        // Nouvelle connexion client
        socket.on('client_connected', (data) => {
            addClientToList(data.client_id, data.username, data.address);
            updateConnectionCount();
            addSystemMessage(`${data.username} (${data.address}) connect√©`);
        });

        // Client d√©connect√©
        socket.on('client_disconnected', (data) => {
            removeClientFromList(data.client_id);
            updateConnectionCount();
            addSystemMessage(`${data.username} (${data.address}) d√©connect√©`);
            if (selectedClient === data.client_id) {
                selectedClient = null;
                updateSelectedClient();
            }
        });

        // Message re√ßu
        socket.on('message_received', (data) => {
            addMessage(data.client_id, data.username, data.message, 'received');
            // Auto-s√©lectionner le client si aucun n'est s√©lectionn√©
            if (!selectedClient) {
                selectClient(data.client_id);
            }
        });

        // Message envoy√© confirm√©
        socket.on('message_sent', (data) => {
            addMessage(data.client_id, 'Vous', data.message, 'sent');
        });

        // Mise √† jour de la liste des clients
        socket.on('clients_update', (data) => {
            updateClientsList(data.clients);
            updateConnectionCount();
        });

        // Ajouter un client √† la liste
        function addClientToList(clientId, username, address) {
            const clientsList = document.getElementById('clients-list');
            const emptyState = clientsList.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const clientElement = document.createElement('div');
            clientElement.className = 'client-item';
            clientElement.id = `client-${clientId}`;
            clientElement.onclick = () => selectClient(clientId);
            clientElement.innerHTML = `
                <div class="client-avatar">${username.charAt(0).toUpperCase()}</div>
                <div class="client-info">
                    <div class="client-name">${username}</div>
                    <div class="client-address">${address}</div>
                </div>
                <div class="client-status"></div>
            `;
            clientsList.appendChild(clientElement);
        }

        // Retirer un client de la liste
        function removeClientFromList(clientId) {
            const clientElement = document.getElementById(`client-${clientId}`);
            if (clientElement) {
                clientElement.remove();
            }
            const clientsList = document.getElementById('clients-list');
            if (clientsList.children.length === 0) {
                clientsList.innerHTML = `
                    <div class="empty-state">
                        <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                            <circle cx="24" cy="24" r="20" stroke="#e0e7ff" stroke-width="2"/>
                            <path d="M24 14v20M14 24h20" stroke="#e0e7ff" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <p>En attente de connexions...</p>
                    </div>
                `;
            }
        }

        // S√©lectionner un client
        function selectClient(clientId) {
            selectedClient = clientId;
            document.querySelectorAll('.client-item').forEach(el => {
                el.classList.remove('active');
            });
            const clientElement = document.getElementById(`client-${clientId}`);
            if (clientElement) {
                clientElement.classList.add('active');
                const username = clientElement.querySelector('.client-name').textContent;
                document.getElementById('selected-client').innerHTML = `
                    <span>R√©pondre √†: <strong>${username}</strong></span>
                `;
                messageInput.disabled = false;
                sendBtn.disabled = false;
                messageInput.focus();
            }
        }

        // Mettre √† jour le client s√©lectionn√©
        function updateSelectedClient() {
            if (!selectedClient) {
                document.getElementById('selected-client').innerHTML = `
                    <span>S√©lectionnez un client pour r√©pondre</span>
                `;
                messageInput.disabled = true;
                sendBtn.disabled = true;
            }
        }

        // Ajouter un message
        function addMessage(clientId, sender, message, type) {
            const welcomeMsg = messagesContainer.querySelector('.welcome-message');
            if (welcomeMsg) welcomeMsg.remove();

            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.innerHTML = `
                <div class="message-avatar">${sender.charAt(0)}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">${sender}</span>
                        <span class="message-time">${new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</span>
                    </div>
                    <div class="message-text">${escapeHtml(message)}</div>
                </div>
            `;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Ajouter un message syst√®me
        function addSystemMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message system';
            messageElement.innerHTML = `
                <div class="system-message">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 0a8 8 0 100 16A8 8 0 008 0zm1 12H7V7h2v5zm0-6H7V4h2v2z"/>
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Envoyer un message
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && selectedClient) {
                socket.emit('send_message', {
                    client_id: selectedClient,
                    message: message
                });
                messageInput.value = '';
                autoResize();
            }
        }

        // Effacer les messages
        function clearMessages() {
            messagesContainer.innerHTML = `
                <div class="welcome-message">
                    <div class="welcome-icon">üí¨</div>
                    <h3>Messages effac√©s</h3>
                    <p>La conversation continue...</p>
                </div>
            `;
        }

        // Mise √† jour du compteur de connexions
        function updateConnectionCount() {
            const count = document.querySelectorAll('.client-item').length;
            document.getElementById('client-count').textContent = count;
            document.querySelector('#active-connections strong').textContent = count;
        }

        // Auto-resize textarea
        function autoResize() {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
        }

        messageInput.addEventListener('input', autoResize);

        // Gestion des touches
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
